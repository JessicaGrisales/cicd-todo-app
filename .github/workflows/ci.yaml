name: CI - Todo App

# Déclencheurs du workflow
on:
  # Lance le CI à chaque push sur la branche main
  push:
    branches:
      - main

  # Lance aussi le CI pour chaque Pull Request
  pull_request:

# Définition des jobs (un workflow peut avoir plusieurs jobs)
jobs:
  # Nom technique du job (utilisé par GitHub en interne)
  backend:
    # Nom lisible du job affiché dans l’interface GitHub
    name: Backend Audit, Lint & Tests

    # Type de machine virtuelle utilisée pour exécuter le job
    runs-on: ubuntu-latest

    # Configuration par défaut pour toutes les commandes `run`
    defaults:
      run:
        # Tous les `run:` seront exécutés dans le dossier backend/
        # évite de répéter le chemin à chaque step
        working-directory: backend

    # Liste des étapes exécutées dans l’ordre
    steps:
      # Étape 1 : récupérer (cloner) le dépôt GitHub
      - name: Checkout repository
        # Action officielle GitHub pour cloner le repo
        uses: actions/checkout@v5

      # Étape 2 : installer Node.js et configurer npm
      - name: Setup Node.js
        # Action officielle pour installer Node.js
        uses: actions/setup-node@v4
        with:
          # Version de Node.js utilisée par le backend
          node-version: 22

          # Active le cache automatique des dépendances npm
          # accélère les exécutions suivantes du CI
          cache: npm

          # Chemin vers le package-lock.json utilisé pour le cache
          # nécessaire car le projet est dans backend/
          cache-dependency-path: backend/package-lock.json

      # Étape 3 : installation propre des dépendances
      - name: Install dependencies
        # npm ci est optimisé pour les environnements CI
        # → utilise package-lock.json
        # → installation rapide et reproductible
        run: npm ci

      # Étape 4 : audit de sécurité des dépendances
      - name: Security audit
        # Lance le script défini dans package.json (audit CI)
        run: npm run audit:ci

      # Étape 5 : vérification du style et de la qualité du code
      - name: Lint
        # Lance ESLint
        run: npm run lint

      # Étape 6 : exécution des tests d'intégration
      - name: Run tests
        # Lance les tests backend
        # si un test échoue, le job échoue
        run: npm run test:ci

  frontend:
    # Nom lisible du job affiché dans l’interface GitHub Actions
    name: Frontend - Audit, Lint & Tests

    # Type de machine virtuelle utilisée pour exécuter le job
    runs-on: ubuntu-latest

    # Configuration par défaut pour toutes les commandes `run`
    defaults:
      run:
        # Tous les `run:` seront exécutés dans le dossier frontend/
        # → évite de répéter le chemin à chaque étape
        working-directory: frontend

    # Liste des étapes exécutées dans l’ordre
    steps:
      # Étape 1 : récupérer (cloner) le dépôt GitHub
      - name: Checkout repository
        # Action officielle GitHub pour cloner le repo
        uses: actions/checkout@v5

      # Étape 2 : installer Node.js et configurer npm
      - name: Setup node
        # Action officielle pour installer Node.js
        uses: actions/setup-node@v4
        with:
          # Version de Node.js utilisée par le frontend
          node-version: 22

          # Active le cache automatique des dépendances npm
          # accélère les exécutions suivantes du CI
          cache: npm

          # Chemin vers le package-lock.json utilisé pour le cache
          # nécessaire car le projet est dans frontend/
          cache-dependency-path: frontend/package-lock.json

      # Étape 3 : installation propre des dépendances
      - name: Install dependencies
        # npm ci est optimisé pour les environnements CI
        # installation rapide et reproductible
        run: npm ci

      # Étape 4 : audit de sécurité des dépendances
      - name: Audit Security
        # Lance le script d’audit défini dans le package.json
        run: npm run audit:ci

      # Étape 5 : vérification de la qualité et du style du code
      - name: Lint
        # Lance le linter
        run: npm run lint

  e2e:
    # Nom lisible du job affiché dans l’interface GitHub Actions
    name: E2E Tests (Cypress)

    # Machine virtuelle utilisée pour exécuter les tests E2E
    runs-on: ubuntu-latest

    # Le job E2E ne démarre que si les jobs backend ET frontend ont réussi
    needs: [backend, frontend]

    # Exécution des tests E2E sur plusieurs navigateurs
    strategy:
      matrix:
        # Liste des navigateurs testés par Cypress
        browser: [edge, chrome, firefox]

    # Liste des étapes exécutées dans l’ordre
    steps:
      # Étape 1 : récupérer (cloner) le dépôt GitHub
      - name: Checkout repository
        # Action officielle GitHub pour cloner le repo
        uses: actions/checkout@v5

      # Étape 2 : installer Node.js sur la machine du CI
      - name: Setup Node.js
        # Action officielle pour installer Node.js
        uses: actions/setup-node@v4
        with:
          # Version de Node.js utilisée pour les tests E2E
          node-version: 22

      # Étape 3 : installation des dépendances backend
      - name: Install backend dependencies
        # Les commandes s’exécutent dans le dossier backend/
        working-directory: backend
        # Installation propre et reproductible des dépendances
        run: npm ci

      # Étape 4 : installation des dépendances frontend
      - name: Install frontend dependencies
        # Les commandes s’exécutent dans le dossier frontend/
        working-directory: frontend
        # Installation propre et reproductible des dépendances
        run: npm ci

      # Étape 5 : démarrage du backend en mode test + vérification de disponibilité
      - name: Start backend API
        # Les commandes s’exécutent dans le dossier backend/
        working-directory: backend
        run: |
          # Démarre le backend en arrière-plan avec NODE_ENV=test
          npm run start:e2e &

          # Message informatif dans les logs CI
          echo "Waiting for backend on http://localhost:3000/health ..."

          # Boucle d’attente : vérifie que le backend répond correctement
          for i in {1..10}; do
            # Appel HTTP silencieux vers l’endpoint /health
            if curl -sSf http://localhost:3000/health > /dev/null; then
              echo "Backend is up !"
              exit 0
            fi
            # Si le backend n’est pas encore prêt, on attend
            echo "Still waiting..."
            sleep 2
          done

          # Si le backend ne démarre pas dans le temps imparti, le job échoue
          echo "Backend did not start in time !"
          exit 1

      # Étape 6 : exécution des tests End-to-End avec Cypress
      - name: Run Cypress E2E tests
        # Action officielle Cypress pour exécuter les tests E2E
        uses: cypress-io/github-action@v6
        with:
          # Dossier de travail pour les tests E2E
          working-directory: frontend

          # Build du frontend en mode test
          build: npm run build:test

          # Démarrage du serveur frontend de test
          start: npm run preview:test

          # URL que Cypress doit attendre avant de lancer les tests
          wait-on: "http://localhost:4173"

          # Temps maximum d’attente (en secondes)
          wait-on-timeout: 60

          # Navigateur utilisé pour les tests (défini par la matrix)
          browser: ${{ matrix.browser }}

          # URL de base utilisée par Cypress pour les tests
          config: baseUrl=http://localhost:4173

  build:
    name: Build Frontend + Backend

    runs-on: ubuntu-latest

    # Ce job ne démarre que si tous les jobs précédents ont réussi
    # (backend, frontend et tests E2E)
    needs:
      - backend
      - frontend
      - e2e

    # Liste des étapes exécutées dans l’ordre
    steps:
      # Étape 1 : récupération du dépôt GitHub
      - name: Checkout repository
        # Action officielle GitHub pour cloner le projet
        uses: actions/checkout@v5

      # Étape 2 : installation de Node.js
      - name: Setup Node.js
        # Action officielle pour configurer Node.js
        uses: actions/setup-node@v4
        with:
          # Version de Node.js utilisée pour le build
          node-version: 22

      # Étape 3 : installation des dépendances backend
      - name: Install backend dependencies
        # Les commandes sont exécutées dans le dossier backend/
        working-directory: backend
        # Installation propre et reproductible des dépendances
        run: npm ci

      # Étape 4 : préparation du backend pour l’exécution
      - name: Backend ready
        working-directory: backend
        run: echo "Backend ready for deployment"

      # Étape 5 : installation des dépendances frontend
      - name: Install frontend dependencies
        # Les commandes sont exécutées dans le dossier frontend/
        working-directory: frontend
        # Installation des dépendances
        run: npm ci

      # Étape 6 : build du frontend
      - name: Build frontend
        # Génération des fichiers statiques optimisés
        # destinés à l’environnement de test ou de production
        working-directory: frontend
        run: npm run build
