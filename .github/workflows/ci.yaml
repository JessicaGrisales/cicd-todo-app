name: CI - Todo App

# Déclencheurs du workflow
on:
  # Lance le CI à chaque push sur la branche main
  push:
    branches:
      - main

  # Lance aussi le CI pour chaque Pull Request
  pull_request:

# Définition des jobs (un workflow peut avoir plusieurs jobs)
jobs:
  # Nom technique du job (utilisé par GitHub en interne)
  backend:
    # Nom lisible du job affiché dans l’interface GitHub
    name: Backend Audit, Lint & Tests

    # Type de machine virtuelle utilisée pour exécuter le job
    runs-on: ubuntu-latest

    # Configuration par défaut pour toutes les commandes `run`
    defaults:
      run:
        # Tous les `run:` seront exécutés dans le dossier backend/
        # évite de répéter le chemin à chaque step
        working-directory: backend

    # Liste des étapes exécutées dans l’ordre
    steps:
      # Étape 1 : récupérer (cloner) le dépôt GitHub
      - name: Checkout repository
        # Action officielle GitHub pour cloner le repo
        uses: actions/checkout@v5

      # Étape 2 : installer Node.js et configurer npm
      - name: Setup Node.js
        # Action officielle pour installer Node.js
        uses: actions/setup-node@v4
        with:
          # Version de Node.js utilisée par le backend
          node-version: 22

          # Active le cache automatique des dépendances npm
          # accélère les exécutions suivantes du CI
          cache: npm

          # Chemin vers le package-lock.json utilisé pour le cache
          # nécessaire car le projet est dans backend/
          cache-dependency-path: backend/package-lock.json

      # Étape 3 : installation propre des dépendances
      - name: Install dependencies
        # npm ci est optimisé pour les environnements CI
        # → utilise package-lock.json
        # → installation rapide et reproductible
        run: npm ci

      # Étape 4 : audit de sécurité des dépendances
      - name: Security audit
        # Lance le script défini dans package.json (audit CI)
        run: npm run audit:ci

      # Étape 5 : vérification du style et de la qualité du code
      - name: Lint
        # Lance ESLint
        run: npm run lint

      # Étape 6 : exécution des tests automatisés
      - name: Run tests
        # Lance les tests backend
        # si un test échoue, le job échoue
        run: npm run test:ci

  frontend:
    # Nom lisible du job affiché dans l’interface GitHub Actions
    name: Frontend - Audit, Lint & Tests

    # Type de machine virtuelle utilisée pour exécuter le job
    runs-on: ubuntu-latest

    # Configuration par défaut pour toutes les commandes `run`
    defaults:
      run:
        # Tous les `run:` seront exécutés dans le dossier frontend/
        # → évite de répéter le chemin à chaque étape
        working-directory: frontend

    # Liste des étapes exécutées dans l’ordre
    steps:
      # Étape 1 : récupérer (cloner) le dépôt GitHub
      - name: Checkout repository
        # Action officielle GitHub pour cloner le repo
        uses: actions/checkout@v5

      # Étape 2 : installer Node.js et configurer npm
      - name: Setup node
        # Action officielle pour installer Node.js
        uses: actions/setup-node@v4
        with:
          # Version de Node.js utilisée par le frontend
          node-version: 22

          # Active le cache automatique des dépendances npm
          # accélère les exécutions suivantes du CI
          cache: npm

          # Chemin vers le package-lock.json utilisé pour le cache
          # nécessaire car le projet est dans frontend/
          cache-dependency-path: frontend/package-lock.json

      # Étape 3 : installation propre des dépendances
      - name: Install dependencies
        # npm ci est optimisé pour les environnements CI
        # installation rapide et reproductible
        run: npm ci

      # Étape 4 : audit de sécurité des dépendances
      - name: Audit Security
        # Lance le script d’audit défini dans le package.json
        run: npm run audit:ci

      # Étape 5 : vérification de la qualité et du style du code
      - name: Lint
        # Lance le linter
        run: npm run lint
